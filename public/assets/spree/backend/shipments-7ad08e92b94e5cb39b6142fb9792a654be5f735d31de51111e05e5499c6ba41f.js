var ShipmentAddVariantView=Backbone.View.extend({events:{"change #add_variant_id":"onSelect","click .add_variant":"onAdd"},onSelect:function(){var t=this.$("#add_variant_id").val(),e=HandlebarsTemplates["variants/autocomplete_stock"],i=this.$("#stock_details");Spree.ajax({url:Spree.routes.variants_api+"/"+t,success:function(t){i.html(e({variant:t})).show()}})},onAdd:function(t){t.preventDefault(),this.$("#stock_details").hide();var e=this.$("input.variant_autocomplete").val(),i=$(t.target).data("stock-location-id"),n=this.$("input.quantity[data-stock-location-id='"+i+"']").val();addVariantFromStockLocation(i,e,n)}});$(function(){$(".js-shipment-add-variant").each(function(){new ShipmentAddVariantView({el:this})})});var ShipShipmentView=Backbone.View.extend({initialize:function(t){this.shipment_number=t.shipment_number},events:{submit:"onSubmit"},onSubmit:function(){return Spree.ajax({type:"PUT",url:Spree.routes.shipments_api+"/"+this.shipment_number+"/ship",data:{send_mailer:this.$("[name='send_mailer']").val()},success:function(){window.location.reload()}}),!1}});updateShipment=function(t,e){var i=Spree.routes.shipments_api+"/"+t;return Spree.ajax({type:"PUT",url:i,data:{shipment:e}})},adjustShipmentItems=function(t,e,i){var n=_.findWhere(shipments,{number:t}),a=_.where(n.inventory_units,{variant_id:e}),s=Spree.routes.shipments_api+"/"+t,r=0;a.length<i?(s+="/add",r=i-a.length):a.length>i&&(s+="/remove",r=a.length-i),0!=r&&Spree.ajax({type:"PUT",url:s,data:{variant_id:e,quantity:r},success:function(){window.location.reload()},error:function(t){window.show_flash("error",t.responseJSON.message)}})},addVariantFromStockLocation=function(t,e,i){var n=_.find(shipments,function(e){return e.stock_location_id==t&&("ready"==e.state||"pending"==e.state)});n==undefined?Spree.ajax({type:"POST",url:Spree.routes.shipments_api,data:{shipment:{order_id:window.order_number},variant_id:e,quantity:i,stock_location_id:t}}).done(function(){window.location.reload()}):adjustShipmentItems(n.number,e,i)};var ShipmentSplitItemView=Backbone.View.extend({tagName:"tr",className:"stock-item-split",initialize:function(t){this.variant=t.variant,this.shipments=t.shipments,this.shipment_number=t.shipment_number,this.max_quantity=t.max_quantity,this.shipmentItemView=t.shipmentItemView,this.render()},events:{"click .cancel-split":"cancelItemSplit","click .save-split":"completeItemSplit"},cancelItemSplit:function(t){t.preventDefault(),this.shipmentItemView.removeSplit(),this.remove()},completeItemSplit:function(t){t.preventDefault();var e,i=this.$(".quantity").val(),n=this.$('[name="item_stock_location"]').val().split(":"),a=n[0],s=n[1],r={original_shipment_number:this.shipment_number,variant_id:this.variant.id,quantity:i};if("stock_location"==a)r.stock_location_id=s,e=Spree.ajax({type:"POST",url:Spree.routes.shipments_api+"/transfer_to_location",data:r});else{if("shipment"!=a)return alert("Please select the split destination."),!1;r.target_shipment_number=s,e=Spree.ajax({type:"POST",url:Spree.routes.shipments_api+"/transfer_to_shipment",data:r})}e.error(function(t){alert(t.responseJSON.message)}).done(function(){window.Spree.advanceOrder()})},template:HandlebarsTemplates["variants/split"],render:function(){var t=_.reject(this.shipments,_.matcher({number:this.shipment_number})),e={variant:this.variant,shipments:t,max_quantity:this.max_quantity};this.$el.html(this.template(e)),this.$('[name="item_stock_location"]').select2({width:"resolve",placeholder:Spree.translations.item_stock_placeholder,minimumResultsForSearch:8})}}),ShipmentItemView=Backbone.View.extend({initialize:function(t){this.shipment_number=t.shipment_number,this.order_number=t.order_number,this.quantity=this.$el.data("item-quantity"),this.variant_id=this.$el.data("variant-id")},events:{"click .delete-item":"onDelete","click .split-item":"onSplit"},removeSplit:function(){this.$(".split-item").show(),this.$(".delete-item").show()},onSplit:function(t){t.preventDefault(),this.$(".split-item").toggle(),this.$(".delete-item").toggle();var e=this;Spree.ajax({type:"GET",url:Spree.routes.variants_api+"/"+this.variant_id}).success(function(t){var i=new ShipmentSplitItemView({shipmentItemView:e,shipment_number:e.shipment_number,variant:t,shipments:window.shipments,max_quantity:e.quantity});e.$el.after(i.$el)})},onDelete:function(t){t.preventDefault(),confirm(Spree.translations.are_you_sure_delete)&&adjustShipmentItems(this.shipment_number,this.variant_id,0)}}),ShipmentEditView=Backbone.View.extend({initialize:function(){var t=this.$("tbody[data-order-number][data-shipment-number]");this.shipment_number=t.data("shipment-number"),this.order_number=t.data("order-number");var e=this;this.$("form.admin-ship-shipment").each(function(){new ShipShipmentView({el:this,shipment_number:e.shipment_number})}),this.$(".stock-item").each(function(){new ShipmentItemView({el:this,shipment_number:e.shipment_number,order_number:e.order_number})})},events:{"click a.edit-method":"toggleMethodEdit","click a.cancel-method":"toggleMethodEdit","click a.save-method":"saveMethod","click a.edit-tracking":"toggleTrackingEdit","click a.cancel-tracking":"toggleTrackingEdit","click a.save-tracking":"saveTracking"},toggleMethodEdit:function(t){t.preventDefault(),this.$("tr.edit-method").toggle(),this.$("tr.show-method").toggle()},saveMethod:function(t){t.preventDefault();var e=this.$("select#selected_shipping_rate_id").val();updateShipment(this.shipment_number,{selected_shipping_rate_id:e}).done(function(){window.location.reload()})},toggleTrackingEdit:function(t){t.preventDefault(),this.$("tr.edit-tracking").toggle(),this.$("tr.show-tracking").toggle()},saveTracking:function(t){t.preventDefault();var e=this.$('[name="tracking"]').val(),i=this;updateShipment(this.shipment_number,{tracking:e}).done(function(t){i.$("tr.edit-tracking").toggle(),i.$("tr.show-tracking").toggle().find(".tracking-value").html($("<strong>").html(Spree.translations.tracking+": ")).append(document.createTextNode(t.tracking))})}});$(function(){$(".js-shipment-edit").each(function(){new ShipmentEditView({el:this})})});