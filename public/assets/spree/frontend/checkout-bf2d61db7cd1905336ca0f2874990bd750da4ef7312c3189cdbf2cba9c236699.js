(function(){var e,t,n,r,i,a,o,s,u,l,c,p,h,d,f,m,g,v,y,C,w,_,b,S,k=[].slice,T=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};e=window.jQuery||window.Zepto||window.$,e.payment={},e.payment.fn={},e.fn.payment=function(){var t,n;return n=arguments[0],t=2<=arguments.length?k.call(arguments,1):[],e.payment.fn[n].apply(this,t)},i=/(\d{1,4})/g,e.payment.cards=r=[{type:"visaelectron",patterns:[4026,417500,4405,4508,4844,4913,4917],format:i,length:[16],cvcLength:[3],luhn:!0},{type:"maestro",patterns:[5018,502,503,56,58,639,6220,67],format:i,length:[12,13,14,15,16,17,18,19],cvcLength:[3],luhn:!0},{type:"forbrugsforeningen",patterns:[600],format:i,length:[16],cvcLength:[3],luhn:!0},{type:"dankort",patterns:[5019],format:i,length:[16],cvcLength:[3],luhn:!0},{type:"visa",patterns:[4],format:i,length:[13,16],cvcLength:[3],luhn:!0},{type:"mastercard",patterns:[51,52,53,54,55,22,23,24,25,26,27],format:i,length:[16],cvcLength:[3],luhn:!0},{type:"amex",patterns:[34,37],format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,length:[15],cvcLength:[3,4],luhn:!0},{type:"dinersclub",patterns:[30,36,38,39],format:/(\d{1,4})(\d{1,6})?(\d{1,4})?/,length:[14],cvcLength:[3],luhn:!0},{type:"discover",patterns:[60,64,65,622],format:i,length:[16],cvcLength:[3],luhn:!0},{type:"unionpay",patterns:[62,88],format:i,length:[16,17,18,19],cvcLength:[3],luhn:!1},{type:"jcb",patterns:[35],format:i,length:[16],cvcLength:[3],luhn:!0}],t=function(e){var t,n,i,a,o,s,u,l;for(e=(e+"").replace(/\D/g,""),a=0,s=r.length;a<s;a++)for(t=r[a],l=t.patterns,o=0,u=l.length;o<u;o++)if(i=l[o],n=i+"",e.substr(0,n.length)===n)return t},n=function(e){var t,n,i;for(n=0,i=r.length;n<i;n++)if(t=r[n],t.type===e)return t},h=function(e){var t,n,r,i,a,o;for(r=!0,i=0,n=(e+"").split("").reverse(),a=0,o=n.length;a<o;a++)t=n[a],t=parseInt(t,10),(r=!r)&&(t*=2),t>9&&(t-=9),i+=t;return i%10==0},p=function(e){var t;return null!=e.prop("selectionStart")&&e.prop("selectionStart")!==e.prop("selectionEnd")||!(null==("undefined"!=typeof document&&null!==document&&null!=(t=document.selection)?t.createRange:void 0)||!document.selection.createRange().text)},b=function(e,t){var n,r;try{n=t.prop("selectionStart")}catch(e){e,n=null}if(r=t.val(),t.val(e),null!==n&&t.is(":focus"))return n===r.length&&(n=e.length),t.prop("selectionStart",n),t.prop("selectionEnd",n)},v=function(e){var t,n,r,i,a,o,s,u;for(null==e&&(e=""),r="\uff10\uff11\uff12\uff13\uff14\uff15\uff16\uff17\uff18\uff19",i="0123456789",o="",t=e.split(""),s=0,u=t.length;s<u;s++)n=t[s],a=r.indexOf(n),a>-1&&(n=i[a]),o+=n;return o},g=function(t){return setTimeout(function(){var n,r;return n=e(t.currentTarget),r=n.val(),r=v(r),r=r.replace(/\D/g,""),b(r,n)})},f=function(t){return setTimeout(function(){var n,r;return n=e(t.currentTarget),r=n.val(),r=v(r),r=e.payment.formatCardNumber(r),b(r,n)})},s=function(n){var r,i,a,o,s,u,l;if(a=String.fromCharCode(n.which),/^\d+$/.test(a)&&(r=e(n.currentTarget),l=r.val(),i=t(l+a),o=(l.replace(/\D/g,"")+a).length,u=16,i&&(u=i.length[i.length.length-1]),!(o>=u||null!=r.prop("selectionStart")&&r.prop("selectionStart")!==l.length)))return s=i&&"amex"===i.type?/^(\d{4}|\d{4}\s\d{6})$/:/(?:^|\s)(\d{4})$/,s.test(l)?(n.preventDefault(),setTimeout(function(){return r.val(l+" "+a)})):s.test(l+a)?(n.preventDefault(),setTimeout(function(){return r.val(l+a+" ")})):void 0},a=function(t){var n,r;if(n=e(t.currentTarget),r=n.val(),8===t.which&&(null==n.prop("selectionStart")||n.prop("selectionStart")===r.length))return/\d\s$/.test(r)?(t.preventDefault(),setTimeout(function(){return n.val(r.replace(/\d\s$/,""))})):/\s\d?$/.test(r)?(t.preventDefault(),setTimeout(function(){return n.val(r.replace(/\d$/,""))})):void 0},m=function(t){return setTimeout(function(){var n,r;return n=e(t.currentTarget),r=n.val(),r=v(r),r=e.payment.formatExpiry(r),b(r,n)})},u=function(t){var n,r,i;if(r=String.fromCharCode(t.which),/^\d+$/.test(r))return n=e(t.currentTarget),i=n.val()+r,/^\d$/.test(i)&&"0"!==i&&"1"!==i?(t.preventDefault(),setTimeout(function(){return n.val("0"+i+" / ")})):/^\d\d$/.test(i)?(t.preventDefault(),setTimeout(function(){var e,t;return e=parseInt(i[0],10),t=parseInt(i[1],10),t>2&&0!==e?n.val("0"+e+" / "+t):n.val(i+" / ")})):void 0},l=function(t){var n,r,i;if(r=String.fromCharCode(t.which),/^\d+$/.test(r))return n=e(t.currentTarget),i=n.val(),/^\d\d$/.test(i)?n.val(i+" / "):void 0},c=function(t){var n,r,i;if("/"===(i=String.fromCharCode(t.which))||" "===i)return n=e(t.currentTarget),r=n.val(),/^\d$/.test(r)&&"0"!==r?n.val("0"+r+" / "):void 0},o=function(t){var n,r;if(n=e(t.currentTarget),r=n.val(),8===t.which&&(null==n.prop("selectionStart")||n.prop("selectionStart")===r.length))return/\d\s\/\s$/.test(r)?(t.preventDefault(),setTimeout(function(){return n.val(r.replace(/\d\s\/\s$/,""))})):void 0},d=function(t){return setTimeout(function(){var n,r;return n=e(t.currentTarget),r=n.val(),r=v(r),r=r.replace(/\D/g,"").slice(0,4),b(r,n)})},_=function(e){var t;return!(!e.metaKey&&!e.ctrlKey)||32!==e.which&&(0===e.which||(e.which<33||(t=String.fromCharCode(e.which),!!/[\d\s]/.test(t))))},C=function(n){var r,i,a,o;if(r=e(n.currentTarget),a=String.fromCharCode(n.which),/^\d+$/.test(a)&&!p(r))return o=(r.val()+a).replace(/\D/g,""),i=t(o),i?o.length<=i.length[i.length.length-1]:o.length<=16},w=function(t){var n,r,i;if(n=e(t.currentTarget),r=String.fromCharCode(t.which),/^\d+$/.test(r)&&!p(n))return i=n.val()+r,i=i.replace(/\D/g,""),!(i.length>6)&&void 0},y=function(t){var n,r,i;if(n=e(t.currentTarget),r=String.fromCharCode(t.which),/^\d+$/.test(r)&&!p(n))return i=n.val()+r,i.length<=4},S=function(t){var n,i,a,o,s;if(n=e(t.currentTarget),s=n.val(),o=e.payment.cardType(s)||"unknown",!n.hasClass(o))return i=function(){var e,t,n;for(n=[],e=0,t=r.length;e<t;e++)a=r[e],n.push(a.type);return n}(),n.removeClass("unknown"),n.removeClass(i.join(" ")),n.addClass(o),n.toggleClass("identified","unknown"!==o),n.trigger("payment.cardType",o)},e.payment.fn.formatCardCVC=function(){return this.on("keypress",_),this.on("keypress",y),this.on("paste",d),this.on("change",d),this.on("input",d),this},e.payment.fn.formatCardExpiry=function(){return this.on("keypress",_),this.on("keypress",w),this.on("keypress",u),this.on("keypress",c),this.on("keypress",l),this.on("keydown",o),this.on("change",m),this.on("input",m),this},e.payment.fn.formatCardNumber=function(){return this.on("keypress",_),this.on("keypress",C),this.on("keypress",s),this.on("keydown",a),this.on("keyup",S),this.on("paste",f),this.on("change",f),this.on("input",f),this.on("input",S),this},e.payment.fn.restrictNumeric=function(){return this.on("keypress",_),this.on("paste",g),this.on("change",g),this.on("input",g),this},e.payment.fn.cardExpiryVal=function(){return e.payment.cardExpiryVal(e(this).val())},e.payment.cardExpiryVal=function(e){var t,n,r,i;return i=e.split(/[\s\/]+/,2),t=i[0],r=i[1],2===(null!=r?r.length:void 0)&&/^\d+$/.test(r)&&(n=(new Date).getFullYear(),n=n.toString().slice(0,2),r=n+r),t=parseInt(t,10),r=parseInt(r,10),{month:t,year:r}},e.payment.validateCardNumber=function(e){var n,r;return e=(e+"").replace(/\s+|-/g,""),!!/^\d+$/.test(e)&&(!!(n=t(e))&&(r=e.length,T.call(n.length,r)>=0&&(!1===n.luhn||h(e))))},e.payment.validateCardExpiry=function(t,n){var r,i,a;return"object"==typeof t&&"month"in t&&(a=t,t=a.month,n=a.year),!(!t||!n)&&(t=e.trim(t),n=e.trim(n),!!/^\d+$/.test(t)&&(!!/^\d+$/.test(n)&&(1<=t&&t<=12&&(2===n.length&&(n=n<70?"20"+n:"19"+n),4===n.length&&(i=new Date(n,t),r=new Date,i.setMonth(i.getMonth()-1),i.setMonth(i.getMonth()+1,1),i>r)))))},e.payment.validateCardCVC=function(t,r){var i,a;return t=e.trim(t),!!/^\d+$/.test(t)&&(i=n(r),null!=i?(a=t.length,T.call(i.cvcLength,a)>=0):t.length>=3&&t.length<=4)},e.payment.cardType=function(e){var n;return e?(null!=(n=t(e))?n.type:void 0)||null:null},e.payment.formatCardNumber=function(n){var r,i,a,o;return n=n.replace(/\D/g,""),(r=t(n))?(a=r.length[r.length.length-1],n=n.slice(0,a),r.format.global?null!=(o=n.match(r.format))?o.join(" "):void 0:null!=(i=r.format.exec(n))?(i.shift(),i=e.grep(i,function(e){return e}),i.join(" ")):void 0):n},e.payment.formatExpiry=function(e){var t,n,r,i;return(n=e.match(/^\D*(\d{1,2})(\D+)?(\d{1,4})?/))?(t=n[1]||"",r=n[2]||"",i=n[3]||"",i.length>0?r=" / ":" /"===r?(t=t.substring(0,1),r=""):2===t.length||r.length>0?r=" / ":1===t.length&&"0"!==t&&"1"!==t&&(t="0"+t,r=" / "),t+r+i):""}}).call(this),function(){Spree.disableSaveOnClick=function(){return $("form.edit_order").submit(function(){return $(this).find(":submit, :image").attr("disabled",!0).removeClass("primary").addClass("disabled")})}}.call(this),function(){Spree.ready(function(e){var t,n,r,i,a,o;if(e("#checkout_form_address").is("*"))return e(".js-address-fields").show(),e("#checkout_form_address").validate(),n=function(t){return e("#"+t+"country select").val()},i={},a=function(r){var a;if(null!=(a=n(r)))return null==i[a]?e.get(Spree.routes.states_search,{country_id:a},function(e){return i[a]={states:e.states,states_required:e.states_required},t(r)}):t(r)},t=function(t){var r,a,o,s,u,l,c,p,h,d;if(r=n(t),null!=(a=i[r]))return h=a.states_required,p=a.states,u=e("#"+t+"state"),l=u.find("select"),s=u.find("input"),c=u.find('[id$="state-required"]'),p.length>0?(o=parseInt(l.val()),l.html(""),d=[{name:"",id:""}].concat(p),e.each(d,function(t,n){var r;return r=e(document.createElement("option")).attr("value",n.id).html(n.name),o===n.id&&r.prop("selected",!0),l.append(r)}),l.prop("disabled",!1).show(),s.hide().prop("disabled",!0),u.show(),h?(l.addClass("required"),c.show()):(l.removeClass("required"),c.hide()),s.removeClass("required")):(l.hide().prop("disabled",!0),s.show(),h?(c.show(),s.addClass("required")):(s.val(""),c.hide(),s.removeClass("required")),u.toggle(!!h),s.prop("disabled",!h),l.removeClass("required"))},e("#bcountry select").change(function(){return a("b")}),e("#scountry select").change(function(){return a("s")}),a("b"),r=e("input#order_use_billing"),r.change(function(){return o(r)}),(o=function(t){return t.is(":checked")?(e("#shipping .inner").hide(),e("#shipping .inner input, #shipping .inner select").prop("disabled",!0)):(e("#shipping .inner").show(),e("#shipping .inner input, #shipping .inner select").prop("disabled",!1),a("s"))})(r)})}.call(this),function(){Spree.ready(function(e){return Spree.onPayment=function(){if(e("#checkout_form_payment").is("*"))return e("#existing_cards").is("*")&&(e("#payment-method-fields").hide(),e("#payment-methods").hide(),e("#use_existing_card_yes").click(function(){return e("#payment-method-fields").hide(),e("#payment-methods").hide(),e(".existing-cc-radio").prop("disabled",!1)}),e("#use_existing_card_no").click(function(){return e("#payment-method-fields").show(),e("#payment-methods").show(),e(".existing-cc-radio").prop("disabled",!0)})),e(".cardNumber").payment("formatCardNumber"),e(".cardExpiry").payment("formatCardExpiry"),e(".cardCode").payment("formatCardCVC"),e(".cardNumber").change(function(){return e(this).parent().siblings(".ccType").val(e.payment.cardType(this.value))}),e('input[type="radio"][name="order[payments_attributes][][payment_method_id]"]').click(function(){if(e("#payment-methods li").hide(),this.checked)return e("#payment_method_"+this.value).show()}),e("#cvv_link").on("click",function(t){var n,r;return n="cvv_info",r="left=20,top=20,width=500,height=500,toolbar=0,resizable=0,scrollbars=1",window.open(e(this).attr("href"),n,r),t.preventDefault()}),e('input[type="radio"]:checked').click()},Spree.onPayment()})}.call(this),function(){Spree.onCouponCodeApply=function(){var e,t,n,r,i,a,o;if(t=$("#order_coupon_code"),""!==(e=$.trim(t.val())))return n=$("#coupon_status"),a="success",r="alert",o=Spree.url(Spree.routes.apply_coupon_code(Spree.current_order_id),{order_token:Spree.current_order_token,coupon_code:e}),n.removeClass([a,r].join(" ")),i=Spree.ajax({method:"PUT",url:o}),i.done(function(){return window.location.reload(),t.val(""),n.addClass(a).html("Coupon code applied successfully.")}),i.fail(function(e){var t;return t=e.responseJSON,n.addClass(r).html(t.error)})},Spree.ready(function(e){return e("#coupon-code-apply-button").click(function(e){return Spree.onCouponCodeApply(e)})})}.call(this);